[background-color="#02303a"]
== Performance
image::gradle/bg-2.png[background, size=cover]

&#x1F680;


=== Performance
image::gradle/bg-2.png[background, size=cover]

image::xkcd-compiling.png[width=55%]

[.center.small]
https://xkcd.com/303


=== Performance
image::gradle/bg-2.png[background, size=cover]

image::monkeyuser-focus.png[width=30%]

[.center.small]
https://www.monkeyuser.com/2018/focus


=== Un build rapide c'est
image::gradle/bg-2.png[background, size=cover]

Moins de temps d'attente

Moins de changements de contexte

Plus de fluidité dans notre travail


// =====================================================================================================================


=== Mesurer c'est douter
image::gradle/bg-2.png[background, size=cover]

[cols="<1,^1",frame=none,grid=none]
|===
a|* Mesurer
* Changer
* Mesurer
* Comparer

a|image::xkcd-optimizing.png[width=65%]

[.small]
https://xkcd.com/1691
|===


=== Build Scans
image::gradle/bg-2.png[background, size=cover]

Un enregistrement permanent de ce qui se passe pendant un build

image::buildscan-example.png[]

image::build-scan-link.svg[link=https://scans.gradle.com/s/rcqiowuogd2xu]


=== `gradle-profiler`
image::gradle/bg-2.png[background, size=cover]

https://github.com/gradle/gradle-profiler

* Scenarios fréquents pour vos developpeurs / CI
** Temps de configuration
** Build incrémental
** Synchronisation IDE
* Benchmarks récurrents pour prévenir les regressions
* Profiling pour identifier les bottlenecks


=== Elements de la performance Gradle
image::gradle/bg-2.png[background, size=cover]

* Construction parallèle
* Gestion de la mémoire


// =====================================================================================================================

=== Construction parallèle
image::gradle/bg-2.png[background, size=cover]

* Parallélisme *maximum* `--max-workers=16`
* Téléchargement des *dépendances*
* *Tâches* utilisant la Worker API
* Parallélisme *entre projets* `--parallel`
* Parallélisme des *tests* +
`tasks.test { maxParallelForks = 16 }`

[.top-margin]
include::../fragments/_diagram_parallel-execution.adoc[]

// =====================================================================================================================


=== Gestion de la mémoire
image::gradle/bg-2.png[background, size=cover]

Un build c'est au minimum deux processus Java +
avec des paramètres mémoire par défaut

*Gradle Client* +
UI (CLI/IDE) et communication avec le _daemon_ +
`-Xmx64m`

*Gradle Daemon* +
Configure et exécute le build +
`-Xmx512m -XX:MaxMetaspaceSize=256m`

Certaines tâches utilisent d'*autres processus* +
`-Xmx512m -XX:MaxMetaspaceSize=256m`


=== Gestion de la mémoire
image::gradle/bg-2.png[background, size=cover]

Comprendre qu'on a un problème mémoire

* Build trop lent
* `Expiring Daemon because JVM heap space is exhausted`
* Les Build Scans montrent la pression mémoire image:build-scan-link.svg[link=https://ge.gradle.org/s/ojxxc2ucs5zjo/performance/build#garbage-collection]
* `gradle-profiler` pour capturer les allocations


=== Gestion de la mémoire
image::gradle/bg-2.png[background, size=cover]

Changer les paramètres mémoire

[.small]
*Gradle CLI* - rarement nécessaire

.Variable d'environnement `JAVA_OPTS`
[source,shell]
----
JAVA_OPTS="-Xmx64m -XX:MaxPermSize=64m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
----

[.small]
*Gradle Daemon*

.`gradle.properties`
[source,properties]
----
org.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
----

[.small]
*Tâches, e.g. `Test`*

.`build.gradle.kts`
[source,kotlin]
----
tasks.test {
    maxHeapSize = "1G"
}
----

[.small.center.top-margin]
link:https://docs.gradle.org/current/userguide/build_environment.html#sec:configuring_jvm_memory[doc/configuring_jvm_memory]


// =====================================================================================================================

=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Principes

* Cache le résultat de la configuration et du calcul du graphe de tâches, et réutilise pour les builds suivants.
* Détection des _inputs_ de la logique de build pour invalidation
* Tâches isolées du modèle de build mutable et entre elles


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Bénéfices

* Quand rien n'a changé, la phase de configuration est complétement sautée
* Moins de pression mémoire car le modèle de build peut être garbage collecté
* Exécution de toutes les tâches en parallèle (incl. intra-projets)


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

image::cc-perf-java.png[]

[background-color="#02303a"]
=== Démo
image::gradle/bg-2.png[background, size=cover]

[.notes]
--
Utiliser `gradle/gradle` +
Execution des tests
--


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Contraintes sur la logique de configuration

* Environnement, fichiers de conf, process externes (e.g. `git`) etc...
* _Build listeners_ enregistrés lors de la configuration, notifiés lors de l'exécution
* link:https://docs.gradle.org/nightly/userguide/configuration_cache.html#config_cache:requirements[configuration_cache#requirements]


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Contraintes sur la logique d'exécution

* Pas de références au modèle de build dans les tâches +
e.g. `Project`, `Task` etc...
* Pas d'objets _live_ dans les _inputs_ +
e.g. `InputStream`, `Socket` etc...
* link:https://docs.gradle.org/nightly/userguide/configuration_cache.html#config_cache:requirements[configuration_cache#requirements]

=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Force les bonnes pratiques

* Claire séparation entre configuration et execution
* Déclaration correcte des _inputs_
* Pas d'interdépendance entre instances de tâches


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Les plugins Core JVM sont compatibles +
tous les autres ne le sont pas encore [link:https://docs.gradle.org/nightly/userguide/configuration_cache.html#config_cache:plugins:core[doc]]

Les plugins Kotlin et Android sont compatibles

De plus en plus de plugins communautaires sont compatibles link:https://github.com/gradle/gradle/issues/13490[gradle/gradle#13490]


=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Feuille de route, à ce jour

* [.line-through]#incubating# => stable dans Gradle 8.x +
  (en opt-in)
* Activé par défaut dans Gradle 9.0 +
  (avec un opt-out)
* Seul mode possible dans Gradle x.x +
  (sans opt-out)

=== Configuration Cache
image::gradle/bg-2.png[background, size=cover]

Cache le résultat de la configuration et du calcul du graphe de tâches, et réutilise pour les builds suivants.

Le jeu en vaut la chandelle

Vous pouvez démarrer son adoption dès aujourd'hui

// =====================================================================================================================


=== Performance
image::gradle/bg-2.png[background, size=cover]

[cols="<1,^1",frame=none,grid=none]
|===
a|* Mesurer
* Changer
* Mesurer
* Comparer

a|image::xkcd-optimizing.png[width=65%]

[.small]
https://xkcd.com/1691
|===
